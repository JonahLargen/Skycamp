@page "/projects"
@rendermode InteractiveServer
@attribute [Authorize]

@inject ApplicationApiClient ApiClient
@inject IToastService ToastService
@inject IDialogService DialogService
@inject WorkspaceStateService WorkspaceStateService
@inject TimeZoneService TimeZoneService
@inject NavigationManager NavigationManager

<PageTitle>Projects</PageTitle>

<h1>Projects</h1>

@if (projects == null)
{
    <FluentStack Orientation="Orientation.Vertical">
        @for (int i = 0; i < 5; i++)
        {
            <FluentSkeleton Shape="SkeletonShape.Rect" Width="100%" Height="40px" Shimmer="true" />
        }
    </FluentStack>
}
else
{
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
        <!-- Action Bar -->
        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
            <FluentSearch @bind-Value="@searchQuery" @bind-Value:after="FilterProjects" 
                          Placeholder="Search projects..." 
                          Style="flex: 1; max-width: 400px;" />
            
            <FluentButton Loading=@refreshLoading IconStart="@(new Icons.Regular.Size16.ArrowRedo())" Appearance="Appearance.Neutral" OnClick="RefreshProjects">
                Refresh
            </FluentButton>

            <FluentButton IconStart="@(new Icons.Regular.Size16.Add())" Appearance="Appearance.Accent" OnClick="AddProject">
                Add Project
            </FluentButton>
        </FluentStack>

        @if (filteredProjects.Count == 0)
        {
            <FluentMessageBar Title="No Projects Found" Intent="MessageIntent.Warning" AllowDismiss=false>
                @(string.IsNullOrWhiteSpace(searchQuery) ? "You currently have no projects. Consider creating one to get started!" : "No projects match your search criteria.")
            </FluentMessageBar>
        }
        else
        {
            <!-- Projects Grid -->
            <FluentGrid Spacing="3" Justify="JustifyContent.FlexStart" Style="width: 100%;">
                @{
                    var hasShownArchivedSeparator = false;
                    
                    foreach (var project in filteredProjects)
                    {
                        // Show separator before first archived project
                        if (project.ArchivedUtc != null && !hasShownArchivedSeparator)
                        {
                            hasShownArchivedSeparator = true;
                            
                            <!-- Archived Projects Separator -->
                            <FluentGridItem xs="12">
                                <FluentDivider Style="margin: 16px 0;" />
                                <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 14px; margin-bottom: 8px;">Archived Projects</FluentLabel>
                            </FluentGridItem>
                        }
                        
                        <FluentGridItem xs="12" sm="6" md="4" lg="3">
                            <FluentCard Style="@($"height: 100%; position: relative;{(project.ArchivedUtc != null ? " opacity: 0.6;" : "")}")">
                                <!-- Favorite Star -->
                                <div style="position: absolute; top: 8px; right: 8px; z-index: 10;">
                                    <FluentButton Appearance="Appearance.Lightweight" 
                                                  IconStart="@(project.IsFavorite ? new Icons.Filled.Size20.Star() : new Icons.Regular.Size20.Star())"
                                                  OnClick="@(() => ToggleFavorite(project))"
                                                  Style="@(project.IsFavorite ? "color: gold;" : "")" />
                                </div>

                                <div @onclick="() => OpenProject(project)" style="cursor: pointer;">
                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                                        <FluentLabel Typo="Typography.H6" Style="margin: 0; padding-right: 32px;">@project.Name</FluentLabel>
                                        
                                        @if (!string.IsNullOrEmpty(project.Description))
                                        {
                                            <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                                @project.Description
                                            </FluentLabel>
                                        }

                                        <!-- Progress Bar -->
                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                                            <FluentLabel Typo="Typography.Body" Style="font-size: 11px;">Progress: @project.Progress.ToString("P0")</FluentLabel>
                                            <FluentProgress Min="0" Max="100" Value="@((int)(project.Progress * 100))" Style="width: 100%;" />
                                        </FluentStack>

                                        <!-- Badges -->
                                        <FluentStack Orientation="Orientation.Horizontal" Wrap="true" HorizontalGap="4">
                                            <FluentBadge Appearance="Appearance.Neutral" Style="font-size: 10px;">@project.RoleName</FluentBadge>
                                            @if (project.ArchivedUtc != null)
                                            {
                                                <FluentBadge Appearance="Appearance.Accent" Style="font-size: 10px;">Archived</FluentBadge>
                                            }
                                            @if (project.IsAllAccess)
                                            {
                                                <FluentBadge Appearance="Appearance.Accent" Style="font-size: 10px;">All Access</FluentBadge>
                                            }
                                        </FluentStack>

                                        <!-- Project Members -->
                                        @if (project.Users?.Any() == true)
                                        {
                                            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="4" VerticalAlignment="VerticalAlignment.Center">
                                                <FluentLabel Typo="Typography.Body" Style="font-size: 10px; color: var(--neutral-foreground-hint);">Members:</FluentLabel>
                                                @foreach (var user in project.Users.Take(3))
                                                {
                                                    <div @onclick="@(() => ShowUserProfile(user.Id))" @onclick:stopPropagation="true" style="cursor: pointer;">
                                                        <FluentPersona Name="@user.DisplayName"
                                                                       Image="@user.AvatarUrl"
                                                                       ImageSize="20px" />
                                                    </div>
                                                }
                                                @if (project.Users.Count > 3)
                                                {
                                                    <FluentLabel Typo="Typography.Body" Style="font-size: 10px; color: var(--neutral-foreground-hint);">
                                                        +@(project.Users.Count - 3)
                                                    </FluentLabel>
                                                }
                                            </FluentStack>
                                        }
                                    </FluentStack>
                                </div>

                                <!-- Actions -->
                                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="4" Style="margin-top: 8px;">
                                    @if (project.RoleName is "Owner" or "Admin")
                                    {
                                        <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Edit())" 
                                                      OnClick="@(() => EditProject(project))" 
                                                      Title="Edit">
                                        </FluentButton>
                                        
                                        @if (project.ArchivedUtc == null)
                                        {
                                            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Archive())" 
                                                          OnClick="@(() => ArchiveProject(project))" 
                                                          Title="Archive">
                                            </FluentButton>
                                        }
                                        else
                                        {
                                            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.ArrowUndo())" 
                                                          OnClick="@(() => UnarchiveProject(project))" 
                                                          Title="Unarchive">
                                            </FluentButton>
                                        }
                                        
                                        <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Delete())" 
                                                      OnClick="@(() => DeleteProject(project))" 
                                                      Title="Delete">
                                        </FluentButton>
                                    }
                                </FluentStack>
                            </FluentCard>
                        </FluentGridItem>
                    }
                }
            </FluentGrid>
        }
    </FluentStack>
}

@code {
    private List<GetProjectsByWorkspaceIdResponseItem>? projects;
    private List<GetProjectsByWorkspaceIdResponseItem> filteredProjects = new();
    private string searchQuery = "";
    private bool refreshLoading = false;
    private WorkspaceState activeWorkspace = null!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var selectedWorkspace = await WorkspaceStateService.GetSelectedWorkspaceAsync();

            if (selectedWorkspace == null)
            {
                NavigationManager.NavigateTo("/workspaces?toast=1");
                return;
            }

            activeWorkspace = selectedWorkspace;

            await TimeZoneService.InitializeAsync();

            var response = await ApiClient.GetProjectsByWorkspaceIdAsync(activeWorkspace.WorkspaceId);

            if (response.IsSuccess && response.Data != null)
            {
                // Sort projects: active first, then favorites, then by name
                projects = response.Data.Projects
                    .OrderBy(p => p.ArchivedUtc.HasValue)
                    .ThenByDescending(p => p.IsFavorite)
                    .ThenBy(p => p.Name)
                    .ToList();

                FilterProjects();
            }
            else
            {
                ToastService.ShowError("Failed to load projects: " + response.ErrorMessage);
            }

            StateHasChanged();
        }
    }

    private void FilterProjects()
    {
        if (projects == null)
        {
            filteredProjects = new();
            return;
        }

        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            filteredProjects = projects;
        }
        else
        {
            var query = searchQuery.ToLower();
            filteredProjects = projects
                .Where(p => 
                    (p.Name?.ToLower().Contains(query) ?? false) ||
                    (p.Description?.ToLower().Contains(query) ?? false) ||
                    (p.RoleName?.ToLower().Contains(query) ?? false))
                .ToList();
        }
    }

    private async Task RefreshProjects()
    {
        refreshLoading = true;

        try
        {
            var response = await ApiClient.GetProjectsByWorkspaceIdAsync(activeWorkspace.WorkspaceId);

            if (response.IsSuccess && response.Data != null)
            {
                // Sort projects: active first, then favorites, then by name
                projects = response.Data.Projects
                    .OrderBy(p => p.ArchivedUtc.HasValue)
                    .ThenByDescending(p => p.IsFavorite)
                    .ThenBy(p => p.Name)
                    .ToList();

                FilterProjects();
            }
            else
            {
                ToastService.ShowError("Failed to load projects: " + response.ErrorMessage);
            }
        }
        finally
        {
            refreshLoading = false;
        }
    }

    private async Task ToggleFavorite(GetProjectsByWorkspaceIdResponseItem project)
    {
        try
        {
            if (projects == null)
            {
                return;
            }

            var result = await ApiClient.ToggleProjectFavoriteAsync(activeWorkspace.WorkspaceId, project.Id);

            if (result.IsSuccess)
            {
                project.IsFavorite = !project.IsFavorite;
                
                // Re-sort projects
                projects = projects
                    .OrderBy(p => p.ArchivedUtc.HasValue)
                    .ThenByDescending(p => p.IsFavorite)
                    .ThenBy(p => p.Name)
                    .ToList();
                
                FilterProjects();
                StateHasChanged();
            }
            else
            {
                ToastService.ShowError($"Failed to toggle favorite: {result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"An error occurred: {ex.Message}");
        }
    }

    private async Task AddProject()
    {
        var parameters = new DialogParameters()
        {
            TrapFocus = true,
            Modal = false
        };
        var data = new AddEditProjectDialogModel()
        {
            WorkspaceId = activeWorkspace.WorkspaceId
        };
        var dialog = await DialogService.ShowDialogAsync<AddEditProjectDialog>(data, parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Cancelled)
        {
            await RefreshProjects();
        }
    }

    private void OpenProject(GetProjectsByWorkspaceIdResponseItem item)
    {
        NavigationManager.NavigateTo($"/projects/{item.Id}");
    }

    private async Task EditProject(GetProjectsByWorkspaceIdResponseItem item)
    {
        var parameters = new DialogParameters()
        {
            TrapFocus = true,
            Modal = false
        };
        var data = new AddEditProjectDialogModel()
        {
            Id = item.Id,
            WorkspaceId = activeWorkspace.WorkspaceId,
            Description = item.Description,
            Name = item.Name,
            IsAllAccess = item.IsAllAccess
        };

        var dialog = await DialogService.ShowDialogAsync<AddEditProjectDialog>(data, parameters);

        var result = await dialog.Result;

        if (result is not null && !result.Cancelled)
        {
            await RefreshProjects();
        }
    }

    private async Task DeleteProject(GetProjectsByWorkspaceIdResponseItem item)
    {
        var parameters = new DialogParameters()
        {
            TrapFocus = true,
            Modal = false
        };
        var data = new DeleteProjectDialogModel()
        {
            ProjectId = item.Id,
            WorkspaceId = activeWorkspace.WorkspaceId
        };

        var dialog = await DialogService.ShowDialogAsync<DeleteProjectDialog>(data, parameters);

        var result = await dialog.Result;

        if (result is not null && !result.Cancelled)
        {
            await RefreshProjects();
        }
    }

    private async Task ArchiveProject(GetProjectsByWorkspaceIdResponseItem item)
    {
        try
        {
            var result = await ApiClient.ArchiveProjectAsync(activeWorkspace.WorkspaceId, item.Id);

            if (result.IsSuccess)
            {
                ToastService.ShowSuccess($"Project '{item.Name}' has been archived.");
                await RefreshProjects();
            }
            else
            {
                ToastService.ShowError($"Failed to archive project: {result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"An error occurred: {ex.Message}");
        }
    }

    private async Task UnarchiveProject(GetProjectsByWorkspaceIdResponseItem item)
    {
        try
        {
            var result = await ApiClient.UnarchiveProjectAsync(activeWorkspace.WorkspaceId, item.Id);

            if (result.IsSuccess)
            {
                ToastService.ShowSuccess($"Project '{item.Name}' has been unarchived.");
                await RefreshProjects();
            }
            else
            {
                ToastService.ShowError($"Failed to unarchive project: {result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"An error occurred: {ex.Message}");
        }
    }

    private async Task ShowUserProfile(string userId)
    {
        var parameters = new DialogParameters()
        {
            TrapFocus = true,
            Modal = false
        };
        var data = new UserProfileDialogModel()
        {
            UserId = userId
        };
        await DialogService.ShowDialogAsync<UserProfileDialog>(data, parameters);
    }
}
