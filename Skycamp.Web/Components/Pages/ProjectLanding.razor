@page "/projects/{projectId:guid}"
@rendermode InteractiveServer

@inject NavigationManager NavigationManager
@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime;
@inject ApplicationApiClient ApplicationApiClient
@inject WorkspaceStateService WorkspaceStateService
@inject TimeZoneService TimeZoneService
@inject IToastService ToastService
@inject IDialogService DialogService

<PageTitle>Project</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="24" Style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
    @if (project == null)
    {
        <FluentStack Orientation="Orientation.Vertical">
            @for (int i = 0; i < 10; i++)
            {
                <FluentSkeleton Shape="SkeletonShape.Rect" Width="100%" Height="40px" Shimmer="true" />
            }
        </FluentStack>
    }
    else
    {
        <!-- Header Section -->
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
            <FluentLabel Typo="Typography.H3" Style="margin: 0;">@project.Title</FluentLabel>
            <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">
                @project.Description
            </FluentLabel>
        </FluentStack>

        <!-- Progress Section -->
        <FluentCard Style="padding: 1.5rem;">
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Center">
                    <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">
                        @project.StatusText
                    </FluentLabel>
                </FluentStack>

                <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                    <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">
                        Last Updated on @project.LastUpdated.ToString("MMM dd") 📅
                    </FluentLabel>

                    <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); cursor: pointer; text-decoration: underline;" @onclick="@(async () => await OpenEditProgressDialog(project))">
                        Update Project Progress
                    </FluentLabel>
                </FluentStack>

                <FluentProgress Min="0" Max="100" Value="@(Convert.ToInt32(project.Progress * 100))" Style="width: 100%;" />

                @if (@project.StartDate != DateTime.MinValue && @project.EndDate != DateTime.MinValue)
                {
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Style="font-size: 12px; color: var(--neutral-foreground-hint);">
                        <span>@project.StartDate.ToString("MMM dd")</span>
                        <span>@project.EndDate.ToString("MMM dd")</span>
                    </FluentStack>
                }
                else
                {
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Style="font-size: 12px; color: var(--neutral-foreground-hint);">
                        No dates have been configured for this project
                    </FluentStack>
                }
            </FluentStack>
        </FluentCard>

        <!-- People Section -->
        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center" HorizontalGap="12">
            <FluentLabel Typo="Typography.Body">Set up people</FluentLabel>
            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" VerticalAlignment="VerticalAlignment.Center">
                @foreach (var person in project.People)
                {
                    <FluentPersona Name="@person.Name"
                                   Image="@person.AvatarUrl"
                                   ImageSize="32px"
                                   Style="cursor: pointer;" />
                }
                @if (project.AdditionalPeopleCount > 0)
                {
                    <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">
                        + @project.AdditionalPeopleCount just following
                    </FluentLabel>
                }
            </FluentStack>
        </FluentStack>

        <!-- Project Items Grid -->
        <FluentGrid Spacing="3" Style="margin-top: 1rem;">
            <FluentGridItem xs="12" sm="6" md="3">
                <FluentCard Style="height: 200px; cursor: pointer; padding: 1.5rem;" @onclick="@(() => NavigateToSection("chat"))">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                        <FluentIcon Value="@(new Icons.Regular.Size24.ChatMultiple())" Color="Color.Accent" />
                        <FluentLabel Typo="Typography.H6">Chat</FluentLabel>
                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">
                            Team conversations
                        </FluentLabel>
                    </FluentStack>
                </FluentCard>
            </FluentGridItem>

            <FluentGridItem xs="12" sm="6" md="3">
                <FluentCard Style="height: 200px; cursor: pointer; padding: 1.5rem;" @onclick="@(() => NavigateToSection("docs"))">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Folder())" Color="Color.Accent" />
                        <FluentLabel Typo="Typography.H6">Docs & Files</FluentLabel>
                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">
                            Project documents
                        </FluentLabel>
                    </FluentStack>
                </FluentCard>
            </FluentGridItem>

            <FluentGridItem xs="12" sm="6" md="3">
                <FluentCard Style="height: 200px; cursor: pointer; padding: 1.5rem;" @onclick="@(() => NavigateToSection("todo"))">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                        <FluentIcon Value="@(new Icons.Regular.Size24.TaskListSquareLtr())" Color="Color.Accent" />
                        <FluentLabel Typo="Typography.H6">Todo Items</FluentLabel>
                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">
                            Track your tasks
                        </FluentLabel>
                    </FluentStack>
                </FluentCard>
            </FluentGridItem>

            <FluentGridItem xs="12" sm="6" md="3">
                <FluentCard Style="height: 200px; cursor: pointer; padding: 1.5rem;" @onclick="@(() => NavigateToSection("kanban"))">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Board())" Color="Color.Accent" />
                        <FluentLabel Typo="Typography.H6">Kanban</FluentLabel>
                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">
                            Visual board
                        </FluentLabel>
                    </FluentStack>
                </FluentCard>
            </FluentGridItem>
        </FluentGrid>

        <!-- Project Activity Section -->
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="12" Style="margin-top: 2rem;">
            <FluentLabel Typo="Typography.H5">Project Activity</FluentLabel>
            <FluentCard Style="padding: 1.5rem;">
                @if (project.Activities?.Any() == true)
                {
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                        @foreach (var activity in project.Activities)
                        {
                            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Top" HorizontalGap="12">
                                <FluentPersona Name="@activity.UserName"
                                               Image="@activity.UserAvatar"
                                               ImageSize="32px" />
                                <FluentStack Orientation="Orientation.Vertical" VerticalGap="4" Style="flex: 1;">
                                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
                                        <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">
                                            @activity.UserName
                                        </FluentLabel>
                                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">
                                            @activity.Timestamp.ToString("MMM dd, h:mm tt")
                                        </FluentLabel>
                                    </FluentStack>
                                    <FluentLabel Typo="Typography.Body">
                                        @activity.Description
                                    </FluentLabel>
                                </FluentStack>
                            </FluentStack>
                            @if (activity != project.Activities.Last())
                            {
                                <FluentDivider Style="width: 100%;" />
                            }
                        }
                    </FluentStack>
                }
                else
                {
                    <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">
                        No recent activity
                    </FluentLabel>
                }
            </FluentCard>
        </FluentStack>
    }
</FluentStack>

@code {
    private ProjectDetails? project;

    [Parameter]
    public Guid? projectId { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await TimeZoneService.InitializeAsync();

            if (projectId != null)
            {
                try
                {
                    var workspace = await WorkspaceStateService.GetSelectedWorkspaceAsync();

                    if (workspace == null)
                    {
                        return;
                    }

                    var projectItem = await ApplicationApiClient.GetProjectByIdAsync(workspace.WorkspaceId, projectId.Value);

                    if (projectItem == null || !projectItem.IsSuccess || projectItem.Data == null)
                    {
                        return;
                    }

                    var projectData = projectItem.Data;

                    project = new ProjectDetails
                    {
                        Id = projectData.Id,
                        Title = projectData.Name,
                        Description = projectData.Description ?? "No Description",
                        Progress = projectData.Progress,
                        StatusText = projectData.ArchivedUtc.HasValue ? "Archived" : "Active",
                        LastUpdated = TimeZoneService.ConvertFromUtc(projectData.LastUpdatedUtc),
                        StartDate = projectData.StartDate.HasValue ? TimeZoneService.ConvertFromUtc(projectData.StartDate.Value) : DateTime.MinValue,
                        EndDate = projectData.EndDate.HasValue ? TimeZoneService.ConvertFromUtc(projectData.EndDate.Value) : DateTime.MinValue,
                        People = projectData.Users.Where(u => u.RoleName != "Viewer").Select(u => new Person
                        {
                            Name = u.DisplayName ?? "User",
                            AvatarUrl = u.AvatarUrl ?? "https://i.pravatar.cc/150?u=2"
                        }).ToList(),
                        AdditionalPeopleCount = projectData.Users.Count(u => u.RoleName == "Viewer"),
                        Activities = new List<Activity>
                        {
                            new Activity
                            {
                                UserName = "Taylor Builder",
                                UserAvatar = "https://i.pravatar.cc/150?img=19",
                                Description = "Added launch pad schematics to Docs & Files.",
                                Timestamp = DateTime.UtcNow.AddHours(-7)
                            },
                            new Activity
                            {
                                UserName = "Skyler Analyst",
                                UserAvatar = "https://i.pravatar.cc/150?img=21",
                                Description = "Commented on the safety checklist.",
                                Timestamp = DateTime.UtcNow.AddDays(-1)
                            },
                            new Activity
                            {
                                UserName = "Pat Tester",
                                UserAvatar = "https://i.pravatar.cc/150?img=24",
                                Description = "Marked the weather monitoring task as done.",
                                Timestamp = DateTime.UtcNow.AddDays(-2)
                            }
                        }
                    };

                    await InvokeAsync(StateHasChanged);
                    await JSRuntime.InvokeVoidAsync("setDocumentTitle", project.Title);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading project: {ex.Message}");
                }
            }
        }
    }

    private async Task OpenEditProgressDialog(ProjectDetails project)
    {
        var workspace = await WorkspaceStateService.GetSelectedWorkspaceAsync();

        if (workspace == null)
        {
            return;
        }

        var parameters = new DialogParameters()
        {
            TrapFocus = true,
            Modal = false
        };
        var data = new EditProjectProgressDialogModel()
        {
            WorkspaceId = workspace.WorkspaceId,
            Id = project.Id,
            Progress = Convert.ToInt32(project.Progress * 100m)
        };
        var dialog = await DialogService.ShowDialogAsync<EditProjectProgressDialog>(data, parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Cancelled)
        {
            var newProgress = (int)result.Data!;

            project.Progress = newProgress / 100m;
        }
    }

    private void NavigateToSection(string section)
    {
        if (section == "chat")
        {
            ToastService.ShowWarning("Chat not implemented yet...");
        }
        else if (section == "docs")
        {
            ToastService.ShowWarning("Docs not implemented yet...");
        }
        else if (section == "todo")
        {
            var uri = new Uri(NavigationManager.Uri);
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);

            NavigationManager.NavigateTo($"/projects/{projectId}/todos");
        }
        else if (section == "kanban")
        {
            ToastService.ShowWarning("Kanban not implemented yet...");
        }
        else
        {
            ToastService.ShowError($"Unknown command: {section}");
        }
    }

    public class ProjectDetails
    {
        public Guid Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal Progress { get; set; }
        public string StatusText { get; set; } = string.Empty;
        public DateTime LastUpdated { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public List<Person> People { get; set; } = new();
        public int AdditionalPeopleCount { get; set; }
        public List<Activity> Activities { get; set; } = new();
    }

    public class Person
    {
        public string Name { get; set; } = string.Empty;
        public string AvatarUrl { get; set; } = string.Empty;
    }

    public class Activity
    {
        public string UserName { get; set; } = string.Empty;
        public string UserAvatar { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
    }
}